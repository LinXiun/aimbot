-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Variables for Settings
local _G = {
    Enabled = true,
    LockActive = false, 
    TeamCheck = true, -- NEW: Ignore teammates
    Sensitivity = 0.5, 
    BoxSize = 200,    
    BoxColor = Color3.fromRGB(0, 255, 255),
    AimKey = Enum.UserInputType.MouseButton2,
    IsMinimized = false
}

-- Create GUI
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local UICorner = Instance.new("UICorner")
local UIStroke = Instance.new("UIStroke")
local Title = Instance.new("TextLabel")
local SensitivitySlider = Instance.new("TextBox")
local BoxSizeSlider = Instance.new("TextBox")
local LockBtn = Instance.new("TextButton") 
local TeamBtn = Instance.new("TextButton") -- NEW: Team Check Toggle
local CloseBtn = Instance.new("TextButton") 
local FOVBox = Instance.new("Frame")
local FOVStroke = Instance.new("UIStroke")

-- GUI Setup
ScreenGui.Name = "BloxFruitsUltra"
ScreenGui.Parent = game.CoreGui
ScreenGui.ResetOnSpawn = false

MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BackgroundTransparency = 0.3
MainFrame.Position = UDim2.new(0.05, 0, 0.4, 0)
MainFrame.Size = UDim2.new(0, 200, 0, 320) -- Slightly taller for new button
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.ClipsDescendants = true

UICorner.CornerRadius = UDim.new(0, 15)
UICorner.Parent = MainFrame

UIStroke.Thickness = 2
UIStroke.Color = Color3.new(1, 1, 1)
UIStroke.Transparency = 0.8
UIStroke.Parent = MainFrame

-- Minimize Button
CloseBtn.Name = "CloseBtn"
CloseBtn.Parent = MainFrame
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 5)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(1, 0)

-- Lock Toggle
LockBtn.Name = "LockBtn"
LockBtn.Parent = MainFrame
LockBtn.Position = UDim2.new(0.1, 0, 0.65, 0)
LockBtn.Size = UDim2.new(0.8, 0, 0, 35)
LockBtn.Text = "Magnetic: OFF"
LockBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
LockBtn.TextColor3 = Color3.new(1, 1, 1)
LockBtn.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", LockBtn).CornerRadius = UDim.new(0, 8)

-- Team Check Toggle
TeamBtn.Name = "TeamBtn"
TeamBtn.Parent = MainFrame
TeamBtn.Position = UDim2.new(0.1, 0, 0.82, 0)
TeamBtn.Size = UDim2.new(0.8, 0, 0, 35)
TeamBtn.Text = "Team Check: ON"
TeamBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
TeamBtn.TextColor3 = Color3.new(1, 1, 1)
TeamBtn.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", TeamBtn).CornerRadius = UDim.new(0, 8)

-- Labels and Inputs
Title.Parent = MainFrame
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Text = "Blox Assist"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

SensitivitySlider.Parent = MainFrame
SensitivitySlider.Position = UDim2.new(0.1, 0, 0.2, 0)
SensitivitySlider.Size = UDim2.new(0.8, 0, 0, 35)
SensitivitySlider.Text = "Sens: " .. tostring(_G.Sensitivity)
SensitivitySlider.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SensitivitySlider.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", SensitivitySlider).CornerRadius = UDim.new(0, 5)

BoxSizeSlider.Parent = MainFrame
BoxSizeSlider.Position = UDim2.new(0.1, 0, 0.4, 0)
BoxSizeSlider.Size = UDim2.new(0.8, 0, 0, 35)
BoxSizeSlider.Text = "Box: " .. tostring(_G.BoxSize)
BoxSizeSlider.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
BoxSizeSlider.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", BoxSizeSlider).CornerRadius = UDim.new(0, 5)

-- FOV Box
FOVBox.Name = "FOVBox"
FOVBox.Parent = ScreenGui
FOVBox.AnchorPoint = Vector2.new(0.5, 0.5)
FOVBox.Position = UDim2.new(0.5, 0, 0.5, 0)
FOVBox.BackgroundTransparency = 1
FOVBox.Size = UDim2.new(0, _G.BoxSize, 0, _G.BoxSize)
FOVStroke.Thickness = 2
FOVStroke.Color = _G.BoxColor
FOVStroke.Parent = FOVBox

-- Logic: UI Interaction
CloseBtn.MouseButton1Click:Connect(function()
    _G.IsMinimized = not _G.IsMinimized
    local targetSize = _G.IsMinimized and UDim2.new(0, 50, 0, 50) or UDim2.new(0, 200, 0, 320)
    TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = targetSize}):Play()
    CloseBtn.Text = _G.IsMinimized and "+" or "X"
    Title.Visible = not _G.IsMinimized
    SensitivitySlider.Visible = not _G.IsMinimized
    BoxSizeSlider.Visible = not _G.IsMinimized
    LockBtn.Visible = not _G.IsMinimized
    TeamBtn.Visible = not _G.IsMinimized
end)

LockBtn.MouseButton1Click:Connect(function()
    _G.LockActive = not _G.LockActive
    LockBtn.Text = _G.LockActive and "Magnetic: ON" or "Magnetic: OFF"
    LockBtn.BackgroundColor3 = _G.LockActive and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(50, 50, 50)
end)

TeamBtn.MouseButton1Click:Connect(function()
    _G.TeamCheck = not _G.TeamCheck
    TeamBtn.Text = _G.TeamCheck and "Team Check: ON" or "Team Check: OFF"
    TeamBtn.BackgroundColor3 = _G.TeamCheck and Color3.fromRGB(0, 100, 200) or Color3.fromRGB(50, 50, 50)
end)

SensitivitySlider.FocusLost:Connect(function()
    local val = tonumber(SensitivitySlider.Text:match("%d+%.?%d*"))
    if val then _G.Sensitivity = math.clamp(val, 0.01, 2) end -- Increased cap for "much stronger"
    SensitivitySlider.Text = "Sens: " .. tostring(_G.Sensitivity)
end)

BoxSizeSlider.FocusLost:Connect(function()
    local val = tonumber(BoxSizeSlider.Text:match("%d+"))
    if val then 
        _G.BoxSize = math.clamp(val, 10, 800)
        FOVBox.Size = UDim2.new(0, _G.BoxSize, 0, _G.BoxSize)
    end
    BoxSizeSlider.Text = "Box: " .. tostring(_G.BoxSize)
end)

-- Aim Logic
local isHoldingAim = false
UserInputService.InputBegan:Connect(function(i, g) if not g and i.UserInputType == _G.AimKey then isHoldingAim = true end end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == _G.AimKey then isHoldingAim = false end end)

local function getTarget()
    local target, minDistance = nil, _G.BoxSize / 2
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            -- Team Check Logic
            if _G.TeamCheck and player.Team == LocalPlayer.Team then continue end
            
            local pos, onScreen = Camera:WorldToViewportPoint(player.Character.Head.Position)
            if onScreen then
                local dist = (Vector2.new(pos.X, pos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if dist < minDistance then
                    minDistance = dist
                    target = player.Character.Head
                end
            end
        end
    end
    return target
end

RunService.RenderStepped:Connect(function()
    if _G.Enabled and (isHoldingAim or _G.LockActive) then
        local target = getTarget()
        if target then
            -- BUFFED PULL: We use a higher Lerp weight and more direct math
            local lookAt = CFrame.new(Camera.CFrame.Position, target.Position)
            -- Strength is now much more noticeable at high Sensitivity
            Camera.CFrame = Camera.CFrame:Lerp(lookAt, _G.Sensitivity * 0.35) 
        end
    end
end)
