-- 1. SAFE INITIALIZATION
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then return end

local function GetGuiParent()
    if gethui then return gethui() end
    local success, coregui = pcall(function() return game:GetService("CoreGui") end)
    if success and coregui then return coregui end
    return LocalPlayer:WaitForChild("PlayerGui")
end

-- CLEANUP OLD GUI
local parent = GetGuiParent()
if parent:FindFirstChild("BloxAssistGui") then parent.BloxAssistGui:Destroy() end

-- 2. SETTINGS
local Settings = {
    Enabled = true,
    LockActive = false, 
    TeamCheck = true, 
    ClickToTarget = true,
    SkillMode = false, 
    TargetPart = "HumanoidRootPart", 
    Sensitivity = 0.5, 
    BoxSize = 200,    
    BoxColor = Color3.fromRGB(0, 255, 255),
    BoxOffsetX = 0, 
    BoxOffsetY = 0,
    HighlightAlpha = 0.5, 
    MaxSkillRange = 150, 
    IsMinimized = false,
    LockedPlayer = nil,
    IsInteracting = false, 
    IsSwiping = false,
    IsKeyHolding = false,
    LastSwipeTime = 0, 
    LastTouchPos = Vector2.new(0,0),
    BoxTimer = 0,
    SkillHotkeys = {
        [Enum.KeyCode.One] = true, [Enum.KeyCode.Two] = true, [Enum.KeyCode.Three] = true, [Enum.KeyCode.Four] = true,
        [Enum.KeyCode.Z] = true, [Enum.KeyCode.X] = true, [Enum.KeyCode.C] = true, [Enum.KeyCode.V] = true, [Enum.KeyCode.F] = true
    }
}

-- 3. GUI CREATION
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BloxAssistGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = parent

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BackgroundTransparency = 0.3
MainFrame.Position = UDim2.new(0.05, 0, 0.3, 0)
MainFrame.Size = UDim2.new(0, 160, 0, 220)
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", MainFrame).Color = Color3.new(1, 1, 1)

local TitleBar = Instance.new("TextLabel", MainFrame)
TitleBar.Size = UDim2.new(1, -35, 0, 30); TitleBar.Position = UDim2.new(0, 5, 0, 0); TitleBar.BackgroundTransparency = 1
TitleBar.Text = "Blox Fruits Assist"; TitleBar.TextColor3 = Color3.new(1,1,1); TitleBar.Font = Enum.Font.GothamBold; TitleBar.TextXAlignment = Enum.TextXAlignment.Left

local ScrollFrame = Instance.new("ScrollingFrame", MainFrame)
ScrollFrame.Size = UDim2.new(1, 0, 1, -35); ScrollFrame.Position = UDim2.new(0, 0, 0, 35); ScrollFrame.BackgroundTransparency = 1; ScrollFrame.ScrollBarThickness = 2
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 350)
local UIListLayout = Instance.new("UIListLayout", ScrollFrame)
UIListLayout.Padding = UDim.new(0, 5); UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local CloseBtn = Instance.new("TextButton", MainFrame)
CloseBtn.Size = UDim2.new(0, 25, 0, 25); CloseBtn.Position = UDim2.new(1, -30, 0, 2); CloseBtn.Text = "X"; CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(1, 0)

local FOVBox = Instance.new("Frame", ScreenGui); local FOVStroke = Instance.new("UIStroke", FOVBox)
FOVBox.AnchorPoint = Vector2.new(0.5, 0.5); FOVBox.BackgroundTransparency = 1; FOVBox.Size = UDim2.new(0, Settings.MaxSkillRange * 2, 0, Settings.MaxSkillRange * 2)
FOVStroke.Thickness = 2; FOVStroke.Color = Settings.BoxColor; FOVStroke.Transparency = 1 

-- 4. UTILITY FUNCTIONS
local function ShowBoxPulse() Settings.BoxTimer = tick() + 2 end

-- NEW: PVP STATUS CHECK
local function isPvpEnabled(player)
    if not player or not player.Character then return false end
    -- Blox Fruits specific PvP BoolValue check
    local pvpValue = player.Character:FindFirstChild("pvp") or player.Character:FindFirstChild("Pvp")
    if pvpValue and pvpValue:IsA("BoolValue") then
        return pvpValue.Value == true
    end
    -- Fallback: If no pvp value is found, we assume they might be hit-able or in a different game
    return true 
end

local function handleHold(btn, callback)
    local h = false
    btn.MouseButton1Down:Connect(function() h = true while h do ShowBoxPulse(); callback(); task.wait(0.05) end end)
    btn.MouseButton1Up:Connect(function() h = false end); btn.MouseLeave:Connect(function() h = false end)
end

local function createControl(text, parent)
    local frame = Instance.new("Frame", parent); frame.Size = UDim2.new(0.9, 0, 0, 30); frame.BackgroundTransparency = 1
    local label = Instance.new("TextLabel", frame); label.Size = UDim2.new(0.4, 0, 1, 0); label.Text = text; label.TextColor3 = Color3.new(1,1,1); label.BackgroundTransparency = 1; label.TextScaled = true
    local m = Instance.new("TextButton", frame); m.Size = UDim2.new(0.2, 0, 0.8, 0); m.Position = UDim2.new(0.45, 0, 0.1, 0); m.Text = "-"
    local p = Instance.new("TextButton", frame); p.Size = UDim2.new(0.2, 0, 0.8, 0); p.Position = UDim2.new(0.7, 0, 0.1, 0); p.Text = "+"
    Instance.new("UICorner", m); Instance.new("UICorner", p)
    return m, p
end

local function createToggle(text, parent, default)
    local btn = Instance.new("TextButton", parent); btn.Size = UDim2.new(0.9, 0, 0, 30); btn.Text = text
    btn.BackgroundColor3 = default and Color3.fromRGB(0, 120, 0) or Color3.fromRGB(50, 50, 50); btn.TextColor3 = Color3.new(1, 1, 1); Instance.new("UICorner", btn)
    return btn
end

-- 5. BUILD CONTROLS
local sM, sP = createControl("Sens", ScrollFrame)
local rM, rP = createControl("Skill Rng", ScrollFrame)
local SkillBtn = createToggle("Skill Mode: OFF", ScrollFrame, false)
local LockBtn = createToggle("Lock: OFF", ScrollFrame, false)
local ClickBtn = createToggle("Click Target: ON", ScrollFrame, true)
local TeamBtn = createToggle("Team Check: ON", ScrollFrame, true)

-- 6. LOGIC & AIMING
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

local TargetHighlight = Instance.new("Highlight")
TargetHighlight.Name = "AssistHighlight"; TargetHighlight.FillTransparency = Settings.HighlightAlpha; TargetHighlight.OutlineColor = Settings.BoxColor
TargetHighlight.Parent = GetGuiParent()

local function getClosestPlayerToCharacter(maxDistance)
    local closest, shortestDist = nil, maxDistance
    local myChar = LocalPlayer.Character
    if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then return nil end
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if Settings.TeamCheck and p.Team == LocalPlayer.Team then continue end
            if not isPvpEnabled(p) then continue end -- Added PvP Check
            local dist = (p.Character.HumanoidRootPart.Position - myChar.HumanoidRootPart.Position).Magnitude
            if dist <= shortestDist then shortestDist = dist; closest = p end
        end
    end
    return closest
end

handleHold(sM, function() Settings.Sensitivity = math.max(0.01, Settings.Sensitivity - 0.05) end)
handleHold(sP, function() Settings.Sensitivity = math.min(5, Settings.Sensitivity + 0.05) end)
handleHold(rM, function() 
    Settings.MaxSkillRange = math.max(10, Settings.MaxSkillRange - 5) 
    FOVBox.Size = UDim2.new(0, Settings.MaxSkillRange * 2, 0, Settings.MaxSkillRange * 2)
end)
handleHold(rP, function() 
    Settings.MaxSkillRange = math.min(1000, Settings.MaxSkillRange + 5) 
    FOVBox.Size = UDim2.new(0, Settings.MaxSkillRange * 2, 0, Settings.MaxSkillRange * 2)
end)

local function UpdateUI()
    SkillBtn.Text = Settings.SkillMode and "Skill Mode: ON" or "Skill Mode: OFF"
    SkillBtn.BackgroundColor3 = Settings.SkillMode and Color3.fromRGB(150, 0, 150) or Color3.fromRGB(50, 50, 50)
    LockBtn.Text = (not Settings.SkillMode and Settings.LockActive) and "Lock: ON" or (Settings.SkillMode and "Lock: DISABLED" or "Lock: OFF")
    LockBtn.BackgroundColor3 = (not Settings.SkillMode and Settings.LockActive) and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(50, 50, 50)
    ClickBtn.Text = (not Settings.SkillMode and Settings.ClickToTarget) and "Click Target: ON" or (Settings.SkillMode and "Click Target: DISABLED" or "Click Target: OFF")
    ClickBtn.BackgroundColor3 = (not Settings.SkillMode and Settings.ClickToTarget) and Color3.fromRGB(150, 150, 0) or Color3.fromRGB(50, 50, 50)
end

SkillBtn.MouseButton1Click:Connect(function() Settings.SkillMode = not Settings.SkillMode; if Settings.SkillMode then Settings.LockActive = false; Settings.LockedPlayer = nil end; UpdateUI() end)
LockBtn.MouseButton1Click:Connect(function() if not Settings.SkillMode then Settings.LockActive = not Settings.LockActive; UpdateUI() end end)
ClickBtn.MouseButton1Click:Connect(function() if not Settings.SkillMode then Settings.ClickToTarget = not Settings.ClickToTarget; if not Settings.ClickToTarget then Settings.LockedPlayer = nil end UpdateUI() end end)
TeamBtn.MouseButton1Click:Connect(function() Settings.TeamCheck = not Settings.TeamCheck; TeamBtn.Text = Settings.TeamCheck and "Team Check: ON" or "Team Check: OFF"; TeamBtn.BackgroundColor3 = Settings.TeamCheck and Color3.fromRGB(0, 100, 200) or Color3.fromRGB(50, 50, 50) end)

CloseBtn.MouseButton1Click:Connect(function()
    Settings.IsMinimized = not Settings.IsMinimized
    TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = Settings.IsMinimized and UDim2.new(0, 50, 0, 30) or UDim2.new(0, 160, 0, 220)}):Play()
    ScrollFrame.Visible = not Settings.IsMinimized; TitleBar.Visible = not Settings.IsMinimized; CloseBtn.Text = Settings.IsMinimized and "+" or "X"
end)

-- 7. MAIN LOOP
RunService.RenderStepped:Connect(function()
    if not Camera then Camera = workspace.CurrentCamera end
    local invCenter = Vector2.new(Camera.ViewportSize.X/2 + Settings.BoxOffsetY, Camera.ViewportSize.Y/2 + Settings.BoxOffsetX)
    FOVBox.Position = UDim2.new(0, invCenter.X, 0, invCenter.Y)
    FOVStroke.Transparency = tick() > Settings.BoxTimer and 1 or 0

    if Settings.SkillMode then
        local target = getClosestPlayerToCharacter(Settings.MaxSkillRange)
        if target and target.Character then
            TargetHighlight.Adornee = target.Character; TargetHighlight.Enabled = true
            if (Settings.IsInteracting or Settings.IsKeyHolding) and not Settings.IsSwiping then
                local part = target.Character:FindFirstChild(Settings.TargetPart) or target.Character:FindFirstChild("HumanoidRootPart")
                if part then
                    Camera.CFrame = Camera.CFrame:Lerp(CFrame.lookAt(Camera.CFrame.Position, part.Position), Settings.Sensitivity * 0.3)
                end
            end
        else TargetHighlight.Enabled = false end
    else
        -- Logic for checking if LockedPlayer still has PvP on
        if Settings.LockedPlayer and not isPvpEnabled(Settings.LockedPlayer) then
            Settings.LockedPlayer = nil
        end

        local actualTarget = Settings.LockedPlayer or nil
        TargetHighlight.Adornee = actualTarget and actualTarget.Character or nil; TargetHighlight.Enabled = (actualTarget ~= nil)
        
        local aimPart = nil
        if actualTarget then
            aimPart = actualTarget.Character:FindFirstChild(Settings.TargetPart) or actualTarget.Character:FindFirstChild("HumanoidRootPart")
        elseif Settings.LockActive then
            local minDist = Settings.BoxSize / 2
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    if Settings.TeamCheck and p.Team == LocalPlayer.Team then continue end
                    if not isPvpEnabled(p) then continue end -- Added PvP Check to FOV Lock
                    local pos, onS = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
                    if onS then
                        local d = (Vector2.new(pos.X, pos.Y) - invCenter).Magnitude
                        if d < minDist then minDist = d; aimPart = p.Character.HumanoidRootPart end
                    end
                end
            end
        end
        if aimPart and not Settings.IsSwiping then
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.lookAt(Camera.CFrame.Position, aimPart.Position), Settings.Sensitivity * 0.15)
        end
    end
end)

-- 8. INPUTS
UserInputService.InputBegan:Connect(function(i, g)
    if Settings.SkillHotkeys[i.KeyCode] then Settings.IsKeyHolding = true end
    if g then return end
    if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
        Settings.IsInteracting = true; Settings.IsSwiping = false; Settings.LastTouchPos = Vector2.new(i.Position.X, i.Position.Y)
    end
end)

UserInputService.InputChanged:Connect(function(i)
    if Settings.IsInteracting and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
        local currentPos = Vector2.new(i.Position.X, i.Position.Y)
        if (currentPos - Settings.LastTouchPos).Magnitude > 10 then Settings.IsSwiping = true; Settings.LastSwipeTime = tick(); Settings.LastTouchPos = currentPos end
    end
end)

UserInputService.InputEnded:Connect(function(i, g)
    if Settings.SkillHotkeys[i.KeyCode] then Settings.IsKeyHolding = false end
    if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
        if Settings.ClickToTarget and not Settings.SkillMode and not Settings.IsSwiping and not g then
            local closest, shortDist = nil, 150 
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    if not isPvpEnabled(p) then continue end -- Added PvP Check to Click Lock
                    local sP, onS = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
                    if onS and (Vector2.new(sP.X, sP.Y) - Vector2.new(i.Position.X, i.Position.Y)).Magnitude < shortDist then closest = p end
                end
            end
            Settings.LockedPlayer = closest
        end
        Settings.IsInteracting = false; Settings.IsSwiping = false
    end
end)

-- 9. METATABLE HOOKS
pcall(function()
    local mt = getrawmetatable(game); setreadonly(mt, false); local oldI = mt.__index; local oldN = mt.__namecall
    mt.__index = newcclosure(function(t, k)
        if Settings.SkillMode and t == Mouse and (k == "Hit" or k == "Target") then
            local tar = getClosestPlayerToCharacter(Settings.MaxSkillRange)
            if tar and tar.Character and tar.Character:FindFirstChild("HumanoidRootPart") then
                return k == "Hit" and tar.Character.HumanoidRootPart.CFrame or tar.Character.HumanoidRootPart
            end
        end
        return oldI(t, k)
    end)
    mt.__namecall = newcclosure(function(self, ...)
        local m = getnamecallmethod(); local a = {...}
        if Settings.SkillMode and (m == "Raycast" or m == "FindPartOnRay") then
            local tar = getClosestPlayerToCharacter(Settings.MaxSkillRange)
            if tar and tar.Character and tar.Character:FindFirstChild("HumanoidRootPart") then
                local tp = tar.Character.HumanoidRootPart.Position
                if m == "Raycast" then a[2] = (tp - a[1]).Unit * a[2].Magnitude
                else a[1] = Ray.new(a[1].Origin, (tp - a[1].Origin).Unit * a[1].Direction.Magnitude) end
                return oldN(self, unpack(a))
            end
        end
        return oldN(self, ...)
    end)
end)
